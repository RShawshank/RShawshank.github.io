<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-loading-bar.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rshawshank.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Nightingale（一）——源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="Nightingale（一）——源码分析">
<meta property="og:url" content="http://rshawshank.github.io/2023/09/20/Nightingale%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="rhb_blog">
<meta property="og:description" content="Nightingale（一）——源码分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309271433463.webp">
<meta property="og:image" content="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309271432496.webp">
<meta property="og:image" content="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309281109504.webp">
<meta property="article:published_time" content="2023-09-20T13:56:08.000Z">
<meta property="article:modified_time" content="2024-01-04T01:49:43.554Z">
<meta property="article:author" content="rhb">
<meta property="article:tag" content="Nightingale">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309271433463.webp">

<link rel="canonical" href="http://rshawshank.github.io/2023/09/20/Nightingale%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Nightingale（一）——源码分析 | rhb_blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">rhb_blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">rao的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">72</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">32</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">177</span></a>

  </li>
        <li class="menu-item menu-item-photos">

    <a href="/photos/" rel="section"><i class="fa fa-camera fa-fw"></i>相册</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
        <li class="menu-item menu-item-readnote">

    <a href="/readnote" rel="section"><i class="fa fa-book fa-fw"></i>阅读笔记</a>

  </li>
        <li class="menu-item menu-item-somethink">

    <a href="/somethink/" rel="section"><i class="fa fa-sticky-note fa-fw"></i>随笔闲谈</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/RShawshank" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://rshawshank.github.io/2023/09/20/Nightingale%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rhb">
      <meta itemprop="description" content="纵浪大化中，不喜亦不惧">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rhb_blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nightingale（一）——源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-20 13:56:08" itemprop="dateCreated datePublished" datetime="2023-09-20T13:56:08Z">2023-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-04 01:49:43" itemprop="dateModified" datetime="2024-01-04T01:49:43Z">2024-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Nightingale/" itemprop="url" rel="index"><span itemprop="name">Nightingale</span></a>
                </span>
            </span>

          
            <div class="post-description">Nightingale（一）——源码分析</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Nightingale源码分析"><a href="#Nightingale源码分析" class="headerlink" title="Nightingale源码分析"></a>Nightingale源码分析</h1><h2 id="Nightingale介绍"><a href="#Nightingale介绍" class="headerlink" title="Nightingale介绍"></a>Nightingale介绍</h2><p>夜莺监控是一款开源云原生观测分析工具，采用 All-in-One 的设计理念，集数据采集、可视化、监控告警、数据分析于一体，与云原生生态紧密集成，提供开箱即用的企业级监控分析和告警能力。</p>
<p>夜莺作为一个服务端组件，可以对接不同的<code>TSDB时序数据库</code>作为数据源，支持的<code>TSDB时序数据库</code>如<code>Prometheus</code>、<code>VictoriaMetrics</code>、<code>Thanos</code>等等。也可以接入日志类数据源（Elasticsearch，Loki【预】），链路追踪数据源（Jaeger）。只要数据进到这些库里了，夜莺就可以对数据源的数据进行分析、告警、可视化，以及后续的事件处理、告警自愈。</p>
<h3 id="夜莺部署架构"><a href="#夜莺部署架构" class="headerlink" title="夜莺部署架构"></a>夜莺部署架构</h3><p>对于网络结构简单或小规模网络场景下，采用<strong>「中心汇聚式部署方案」</strong>实施比较简单，可以<code>n9e</code>核心组件采用单机或集群方式搭建，集群模式下前端需架设<code>Nginx</code>作为软负载或<code>F5</code>进行硬件设备负载，同时依赖<code>MySQL</code>和<code>Redis</code>中间件存储基础的元数据、用户信息等，不存在大数据量问题，因此，不用太考虑性能瓶颈。</p>
<p><code>Categraf</code>是夜莺团队开发维护的监控采集侧核心组件，类似<code>Telegraf</code>、<code>Grafana-Agent</code>、<code>Datadog-Agent</code>，希望对所有常见监控对象提供监控数据采集能力，采用<code>All-in-one</code>的设计，不但支持指标采集，也希望支持日志和调用链路的数据采集。<code>Categraf</code>采集器采集了数据推送给夜莺，然后转存到后端数据源，如<code>TSDB</code>、<code>ElasticSearch</code>等。</p>
<blockquote>
<p>Categraf不属于夜莺监控系统组件，夜莺定位是服务端组件，不侧重监控数据采集侧。</p>
</blockquote>
<h4 id="categraf采集组件"><a href="#categraf采集组件" class="headerlink" title="categraf采集组件"></a>categraf采集组件</h4><p>1、<code>categraf</code>采集器采用推送模式(push)，push模式导致采集器存在状态，即采集器要知道自己要推送给哪个服务后端的配置，少量categraf采集器来说无所谓，但是一旦成千上万采集点，甚至几百采集点，维护成本都是比较高的，特别是后端地址发生变更等。</p>
<p>2、push模式还存在接入权限问题，因为往往服务后端和采集器维护是两拨人，服务后端是运维人员，而采集器是项目组人员维护，比较难于控制接入，可能个别项目组大量接入采集点造成服务端压力过大奔溃，从而影响整个系统运行稳定。</p>
<p>3、push模式还存在推送频率问题，<code>categraf</code>组件可以配置推送频率，但是只能在采集器端控制，不同项目组运维人员可能配置不同推送频率，难以从全局控制，或者这么个场景：前期采集点少，数据量不大，推送频率5s，但是后面接入的越来越多，存储不够用，需要下调推送频率15s，没有统一修改调整方式。</p>
<h4 id="中心汇聚式部署方案"><a href="#中心汇聚式部署方案" class="headerlink" title="中心汇聚式部署方案"></a>中心汇聚式部署方案</h4><p>所有机房网络域下监控数据采集器都直接推数据给<code>n9e</code>，这个架构最为简单，维护成本最低。集群方式也很简单，只需要部署多节点即可实现。当然，前提是<strong>「要求机房网络域结构简单、规模不大场景，即不太关注跨网络域访问安全问题和大规模跨网络域传输数据网络带宽限制等」</strong>。</p>
<p><img src="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309271433463.webp" alt="中心汇聚式部署方案"></p>
<p>对于 n9e 来说，它本身依赖的存储有两个</p>
<ul>
<li>Mysql : 存放配置类别信息，如用户，监控大盘，告警规则等</li>
<li>Redis : 存放访问令牌(JWT Token)，心跳信息，如机器列表中CPU、内存、时间偏移、核数、操作系统、CPU架构等</li>
</ul>
<p>数据来源：</p>
<ul>
<li>n9e 可以支持多种采集器 agent，比如 Datadog-Agent，Telegraf，Grafana-Agent，OpenTSDB agent，Node-Exporter，vmagent 都可以对接，不过最推荐的还是 Categraf。</li>
</ul>
<p>如果非上述场景，则要使用下面的<strong>「边缘下沉式混杂部署方案：」</strong></p>
<h4 id="边缘下沉式混杂部署方案"><a href="#边缘下沉式混杂部署方案" class="headerlink" title="边缘下沉式混杂部署方案"></a>边缘下沉式混杂部署方案</h4><p><img src="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309271432496.webp" alt="边缘下沉式混杂部署方案"></p>
<p>「边缘下沉式混杂部署方案」中涉及到两个核心组件：「n9e-pushgw组件」和「n9e-alert组件」。</p>
<p><strong>「n9e-pushgw组件」</strong>提供类似于<code>remote_write</code>和<code>remote_read</code>功能，<code>categraf</code>采集器将数据通过<code>remote_write</code>推送给<code>n9e-pushgw</code>组件，然后转存到<code>tsdb</code>时序数据，<code>n9e</code>服务端查询检索数据时通过<code>remote_read</code>讲求转发到对应机房下的<code>n9e-pushgw</code>组件。<code>n9e-alert</code>组件提供基于<code>tsdb</code>时序库中的指标数据告警功能。</p>
<h2 id="项目目录"><a href="#项目目录" class="headerlink" title="项目目录"></a>项目目录</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./</span></span><br><span class="line">├── LICENSE  <span class="string">//</span>开源协议</span><br><span class="line">├── Makefile  <span class="string">//</span>构建脚本</span><br><span class="line">├── README.md</span><br><span class="line">├── README_en.md</span><br><span class="line">├── alert/ <span class="string">//</span>告警引擎相关<span class="comment">##**</span></span><br><span class="line">├── center/ <span class="string">//</span>中心端<span class="params">(节点)</span>管理相关<span class="comment">##**</span></span><br><span class="line">├── cli/ <span class="string">//</span>版本升级相关**</span><br><span class="line">├── cmd/ <span class="string">//</span>项目的可执行文件</span><br><span class="line">├── conf/ <span class="string">//</span>解析配置文件相关</span><br><span class="line">├── doc/ <span class="string">//</span>文档相关</span><br><span class="line">├── docker/ <span class="string">//</span>容器相关</span><br><span class="line">├── etc/  <span class="string">//</span>配置文件目录</span><br><span class="line">├── fe.sh*</span><br><span class="line">├── go.mod  <span class="string">//</span>项目版本依赖包</span><br><span class="line">├── go.sum</span><br><span class="line">├── integrations/ <span class="string">//</span>内置模板，监控大盘和告警规则</span><br><span class="line">├── memsto/ <span class="string">//</span>猜测是memory storage，缓存相关</span><br><span class="line">├── models/ <span class="string">//</span>模型定义</span><br><span class="line">├── pkg/ <span class="string">//</span>公开的库代码，可被外部应用程序依赖使用</span><br><span class="line">├── prom/ <span class="string">//</span>对PromQL的支持相关</span><br><span class="line">├── pushgw/ <span class="string">//</span>转发网关<span class="params">(收采集器,发时序库)</span>**</span><br><span class="line">└── storage/  <span class="string">//</span>存储模块，里面有redis<span class="comment">##和关系库**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>四大模块：</p>
<ul>
<li>cli，升级用和主业务无关，先不了解</li>
<li>center，中心节点也就是n9e的完整版包含各种管理和配置，会调用alert和pushgw模块</li>
<li>alert，告警引擎，告警功能的各种代码</li>
<li>pushgw，转发网关，接收各种采集器的数据转发给时序库</li>
</ul>
<h2 id="alert告警引擎"><a href="#alert告警引擎" class="headerlink" title="alert告警引擎"></a>alert告警引擎</h2><p><img src="https://picture11111111.oss-cn-hangzhou.aliyuncs.com/img/202309281109504.webp" alt="架构图"></p>
<ul>
<li>collector 即 agent，可以采集机器常见指标，原生支持日志监控，支持插件机制，支持业务通过接口直接上报数据；</li>
<li>transfer提供 rpc 接口接收 collector 上报的数据，然后通过一致性哈希，将数据转发给多台tsdb和多台judge；</li>
<li>tsdb 即 open-falcon 中的 graph 组件，用于存储历史数据，支持配置为双写模式提升系统容灾能力，tsdb 会把监控数据转发一份给 index 建索引；</li>
<li>index 是内存索引模块，替换原来的 mysql 方案，在内存里构建索引，便于后续数据检索，在检索的灵活性和检索性能方面大幅提升；</li>
<li>judge 是告警引擎，周期性的从 monapi(portal) 同步监控策略，然后对接收到的数据做告警判断，如满足阈值，则生成告警事件推送到 redis 队列； </li>
<li>monapi(alarm) 从 redis 队列中读取 judge 生成的事件，进行二次处理，补充一些元信息，生成告警消息（alert），重新推送回 redis 队列；</li>
<li>各发送组件，比如 mail-sender、sms-sender 等，从 redis 读取告警消息，发送告警，抽象出各类 sender 是为了后续定制方便；</li>
<li>monapi 集成了原来多个模块的功能，提供接口给 js 调用，api 前缀为 &#x2F;api&#x2F;portal，数据查询走 transfer，去除了 open-falcon 中原来的 query 组件，api 前缀为 &#x2F;api&#x2F;transfer，索引查询的 api 前缀 &#x2F;api&#x2F;index，于是，在前端统一搭建 nginx，即可通过不同 location 将请求转发到不同后端；</li>
<li>数据库仍然使用 MySQL，主要存储的内容包括：用户信息、团队信息、树节点信息、告警策略、监控大盘、屏蔽策略、采集策略、部分组件心跳信息等。</li>
</ul>
<h3 id="告警引擎目录"><a href="#告警引擎目录" class="headerlink" title="告警引擎目录"></a>告警引擎目录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">tree -LF <span class="number">3</span> .</span><br><span class="line">./</span><br><span class="line">├── aconf/  <span class="comment">//告警配置</span></span><br><span class="line">│   └── conf<span class="selector-class">.go</span></span><br><span class="line">├── alert<span class="selector-class">.go</span> <span class="comment">//告警初始化入口</span></span><br><span class="line">├── astats/ <span class="comment">//统计信息</span></span><br><span class="line">│   └── stats<span class="selector-class">.go</span></span><br><span class="line">├── common/ <span class="comment">//通用方法或结构体</span></span><br><span class="line">│   ├── conv<span class="selector-class">.go</span> <span class="comment">//转换成异常点结构体</span></span><br><span class="line">│   └── key<span class="selector-class">.go</span> <span class="comment">//规则key序列化和标签判断</span></span><br><span class="line">├── dispatch/ <span class="comment">//发送告警</span></span><br><span class="line">│   ├── consume<span class="selector-class">.go</span> <span class="comment">//消费者</span></span><br><span class="line">│   ├── dispatch<span class="selector-class">.go</span> <span class="comment">//生产者</span></span><br><span class="line">│   ├── log<span class="selector-class">.go</span> <span class="comment">//日志记录</span></span><br><span class="line">│   ├── notify_channel<span class="selector-class">.go</span> <span class="comment">//通知通道的map</span></span><br><span class="line">│   └── notify_target<span class="selector-class">.go</span> <span class="comment">//通知目标结构体，维护发送目标</span></span><br><span class="line">├── eval/ <span class="comment">//评估</span></span><br><span class="line">│   ├── alert_rule<span class="selector-class">.go</span> <span class="comment">//告警调度</span></span><br><span class="line">│   └── eval<span class="selector-class">.go</span> <span class="comment">//查询时序库评估告警，查询promql</span></span><br><span class="line">├── mute/ <span class="comment">//屏蔽</span></span><br><span class="line">│   └── mute<span class="selector-class">.go</span> <span class="comment">//告警屏蔽</span></span><br><span class="line">├── naming/ <span class="comment">//告警命名</span></span><br><span class="line">│   ├── hashring<span class="selector-class">.go</span> <span class="comment">//数据源对应哈希环</span></span><br><span class="line">│   └── heartbeat<span class="selector-class">.go</span> <span class="comment">//告警心跳维护</span></span><br><span class="line">├── process/ <span class="comment">//告警处理</span></span><br><span class="line">│   ├── alert_cur_event<span class="selector-class">.go</span> <span class="comment">//告警发生的事件的map</span></span><br><span class="line">│   └── process<span class="selector-class">.go</span> <span class="comment">//告警处理</span></span><br><span class="line">├── queue/ <span class="comment">//告警队列</span></span><br><span class="line">│   └── queue<span class="selector-class">.go</span> <span class="comment">//Gauge类型的告警队列</span></span><br><span class="line">├── record/ <span class="comment">//记录规则</span></span><br><span class="line">│   ├── prom_rule<span class="selector-class">.go</span> <span class="comment">//将记录规则写入时序库</span></span><br><span class="line">│   ├── sample<span class="selector-class">.go</span> <span class="comment">//样本，转换记录用</span></span><br><span class="line">│   └── scheduler<span class="selector-class">.go</span> <span class="comment">//记录规则调度</span></span><br><span class="line">├── router/ <span class="comment">//告警路由</span></span><br><span class="line">│   ├── router<span class="selector-class">.go</span> <span class="comment">//告警路由</span></span><br><span class="line">│   └── router_event<span class="selector-class">.go</span> <span class="comment">//告警事件路由</span></span><br><span class="line">└── sender/ <span class="comment">//告警通知发送渠道</span></span><br><span class="line">    ├── callback<span class="selector-class">.go</span> <span class="comment">//回调</span></span><br><span class="line">    ├── dingtalk<span class="selector-class">.go</span> <span class="comment">//钉钉</span></span><br><span class="line">    ├── email<span class="selector-class">.go</span> <span class="comment">//邮件</span></span><br><span class="line">    ├── feishu<span class="selector-class">.go</span> <span class="comment">//飞书</span></span><br><span class="line">    ├── mm<span class="selector-class">.go</span> <span class="comment">//mm</span></span><br><span class="line">    ├── plugin<span class="selector-class">.go</span> <span class="comment">//脚本</span></span><br><span class="line">    ├── plugin_cmd_unix<span class="selector-class">.go</span> <span class="comment">//linux脚本</span></span><br><span class="line">    ├── plugin_cmd_windows<span class="selector-class">.go</span> <span class="comment">//window脚本</span></span><br><span class="line">    ├── sender<span class="selector-class">.go</span> <span class="comment">//发送通知</span></span><br><span class="line">    ├── telegram<span class="selector-class">.go</span> <span class="comment">//telegram</span></span><br><span class="line">    ├── webhook<span class="selector-class">.go</span> <span class="comment">//webhook</span></span><br><span class="line">    └── wecom<span class="selector-class">.go</span> <span class="comment">//企业微信</span></span><br><span class="line"></span><br><span class="line"><span class="number">13</span> directories, <span class="number">35</span> files</span><br></pre></td></tr></table></figure>

<p>入口函数在同名的alert.go，只有两个函数<code>Initialize(configDir string， cryptoKey string) (func()， error)</code>和<code>Start(alertc aconf.Alert， pushgwc pconf.Pushgw， ...lots of arg... isCenter bool) </code>，打包的n9e程序通过Start函数接入告警引擎，n9e-alert通过Initialize函数完成一些配置工作，然后也是调用Start函数来实现调用。</p>
<p>其中n9e-alert程序有三个参数，其中configs和crypto-key是Initialize函数需要的参数。</p>
<ul>
<li>configs 配置文件路径，优先读取环境变量中N9E_CONFIGS的值没有设置为默认值etc，</li>
<li>crypto-key 加密密钥，默认’’</li>
<li>version 是否输出版本，默认false，如果是true，打印在输出到控制台上后立即结束程序</li>
</ul>
<p>配置文件可支持 toml, json, yaml三种类型；<br>由于告警配置Alert.Heartbeat中IP属性建议设置一个唯一值，配置文件没有填写会自动填充，其逻辑如下：</p>
<ol>
<li>首先通过AliDNS获取本机ip</li>
<li>没有获取到有效值会尝试获取hostname，获取失败会直接退出程序</li>
<li>获取hostname中包含localhost会打印一个提示建议用一个唯一值</li>
<li>在填充完 config.Alert.Heartbeat.IP 后会再根据配置文件HTTP.Port的配置(17000)组合一起设置 config.Alert.Heartbeat.Endpoint 属性</li>
</ol>
<p>syncStats是两个用于监控同步状态的Exporter:duration和sync_number</p>
<ul>
<li><p>duration是定时任务使用时长</p>
</li>
<li><p>sync_number是定时任务同步数量。</p>
</li>
</ul>
<p>alertStats是6个用于监控告警状态的Exporter</p>
<ul>
<li>samples_received_total:从各个接收接口接收到的监控数据总量</li>
<li>alerts_total:产生的告警总量</li>
<li>alert_queue_size:内存中的告警事件队列的长度</li>
<li>sample_queue_size:数据转发队列，各个队列的长度</li>
<li>http_request_duration_seconds:一些重要的请求，比如接收数据的请求，应该统计一下延迟情况</li>
<li>forward_duration_seconds:发往后端TSDB，延迟如何</li>
</ul>
<h3 id="告警引擎启动入口-Start"><a href="#告警引擎启动入口-Start" class="headerlink" title="告警引擎启动入口-Start"></a>告警引擎启动入口-Start</h3><ol>
<li><p>查询数据中用户，用户团队，订阅告警，记录规则信息并生成时序库的统计指标；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建UserCacheType类型，查询数据库中user表，设置标签为sync_users的统计指标值，并启用单独线程9s同步一次数据，并返回指针，用户</span></span><br><span class="line">userCache := memsto.NewUserCache(ctx, syncStats)</span><br><span class="line"><span class="comment">//查询user_group表，设置标签为sync_user_groups的统计指标值，用户团队</span></span><br><span class="line">userGroupCache := memsto.NewUserGroupCache(ctx, syncStats)</span><br></pre></td></tr></table></figure>

<ul>
<li>users 是用户表，保存了用户基础数据，除了通过管理员在页面上手动添加，还通过可以对接公司内部 SSO 系统来添加用户（当用户通过 SSO 登录的时候会自动把这个用户的信息插入 users 表）</li>
<li>user_group 是团队表，默认添加了 demo-root-group 团队。</li>
</ul>
</li>
<li><p>初始化设置告警渠道，渠道联系的机器人和系统配置的告警模版等配置；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启用单独线程初始化，获取config表数据，保证数据库有告警内置告警渠道，渠道机器人和告警模版</span></span><br><span class="line"><span class="keyword">go</span> models.InitNotifyConfig(ctx, alertc.Alerting.TemplatesDir)</span><br></pre></td></tr></table></figure>

<ul>
<li>configs 是夜莺平台配置表，存放系统中的多种配置信息。就只保存有配置键和配置值</li>
</ul>
</li>
<li><p>按心跳配置更新告警引擎中的服务列表 ；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">naming := naming.NewNaming(ctx, alertc.Heartbeat)</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化时序库相关；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writers := writer.NewWriters(pushgwc)</span><br></pre></td></tr></table></figure>
</li>
<li><p>记录规则调度,告警记录调度；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录规则调度</span></span><br><span class="line">	record.NewScheduler(alertc, recordingRuleCache, promClients, writers, alertStats)</span><br><span class="line">	<span class="comment">//告警规则调度</span></span><br><span class="line">	eval.NewScheduler(alertc, externalProcessors, alertRuleCache, targetCache, busiGroupCache, alertMuteCache, datasourceCache, promClients, naming, ctx, alertStats)</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建告警发送Notify实例，创建告警消费实例Consumer；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp := dispatch.NewDispatch(alertRuleCache, userCache, userGroupCache, alertSubscribeCache, targetCache, notifyConfigCache, alertc.Alerting, ctx)</span><br></pre></td></tr></table></figure>
</li>
<li><p>单独线程 更新告警内置模版Tpl文件内容，统计信息，邮件发送；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建告警消费实例Consumer</span></span><br><span class="line"><span class="keyword">go</span> dp.ReloadTpls()</span><br><span class="line"><span class="comment">//消费告警，</span></span><br><span class="line"><span class="keyword">go</span> consumer.LoopConsume()</span><br><span class="line"><span class="comment">//每秒统计一次队列数量</span></span><br><span class="line"><span class="keyword">go</span> queue.ReportQueueSize(alertStats)</span><br><span class="line"><span class="comment">// 告警发送邮件方式处理</span></span><br><span class="line"><span class="keyword">go</span> sender.InitEmailSender(notifyConfigCache.GetSMTP())</span><br></pre></td></tr></table></figure>
</li>
<li><p>单独线程 消费告警；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消费告警，</span></span><br><span class="line"><span class="keyword">go</span> consumer.LoopConsume()</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="发送告警"><a href="#发送告警" class="headerlink" title="发送告警"></a>发送告警</h3><h4 id="通知目标"><a href="#通知目标" class="headerlink" title="通知目标"></a>通知目标</h4><p>notify_target.go</p>
<p>结构体 <code>NotifyTarget</code></p>
<ul>
<li>字段：<ul>
<li><code>userMap</code>：一个映射，键是用户ID，值是<code>NotifyChannels</code>类型，用于存储用户的通知渠道信息。</li>
<li><code>webhooks</code>：一个映射，键是Webhook的URL，值是<code>models.Webhook</code>类型，用于存储Webhook信息。</li>
<li><code>callbacks</code>：一个映射，键是字符串，值是空结构体，用于存储回调信息。</li>
</ul>
</li>
<li><strong>描述</strong>：<code>NotifyTarget</code>结构体维护所有需要发送的目标用户和通道&#x2F;回调&#x2F;钩子信息。</li>
</ul>
<p>方法分析：</p>
<p>方法 <code>NewNotifyTarget() *NotifyTarget</code></p>
<ul>
<li><strong>返回</strong>：返回一个新的<code>NotifyTarget</code>实例，其中的映射都是空的。</li>
</ul>
<p>方法 <code>OrMerge(other *NotifyTarget)</code></p>
<ul>
<li><strong>参数</strong>：<code>other</code>是另一个<code>NotifyTarget</code>实例。</li>
<li><strong>逻辑</strong>：将<code>other</code>中的信息按照”或”的方式合并到当前实例中。</li>
</ul>
<p>方法 <code>AndMerge(other *NotifyTarget)</code></p>
<ul>
<li><strong>参数</strong>：<code>other</code>是另一个<code>NotifyTarget</code>实例。</li>
<li><strong>逻辑</strong>：将<code>other</code>中的信息按照”与”的方式合并到当前实例中。</li>
</ul>
<p>方法 <code>merge(other *NotifyTarget, f func(NotifyChannels, NotifyChannels))</code></p>
<ul>
<li>参数：<ul>
<li><code>other</code>：另一个<code>NotifyTarget</code>实例。</li>
<li><code>f</code>：一个函数，用于合并<code>NotifyChannels</code>。</li>
</ul>
</li>
<li><strong>逻辑</strong>：合并<code>other</code>中的信息到当前实例中。</li>
</ul>
<p>方法 <code>ToChannelUserMap() map[string][]int64</code></p>
<ul>
<li><strong>返回</strong>：返回一个映射，键是通道名，值是用户ID的切片。</li>
</ul>
<p>方法 <code>ToCallbackList() []string</code></p>
<ul>
<li><strong>返回</strong>：返回一个包含所有回调的切片。</li>
</ul>
<p>方法 <code>ToWebhookList() []*models.Webhook</code></p>
<ul>
<li><strong>返回</strong>：返回一个包含所有Webhook的切片。</li>
</ul>
<p>类型 <code>NotifyTargetDispatch</code></p>
<ul>
<li><strong>描述</strong>：一个函数类型，用于定义从告警事件到信息接收者的路由策略。</li>
</ul>
<p>函数 <code>NotifyGroupDispatch(...) *NotifyTarget</code></p>
<ul>
<li><strong>逻辑</strong>：处理告警规则的组订阅关系。</li>
</ul>
<p>函数 <code>GlobalWebhookDispatch(...) *NotifyTarget</code></p>
<ul>
<li><strong>逻辑</strong>：获取并处理全局Webhook。</li>
</ul>
<p>函数 <code>EventCallbacksDispatch(...) *NotifyTarget</code></p>
<ul>
<li><strong>逻辑</strong>：处理事件回调。</li>
</ul>
<h4 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h4><p>dispatch.go</p>
<p>结构体 <code>Dispatch</code>：</p>
<ul>
<li>字段：<ul>
<li><code>alertRuleCache</code> 到 <code>notifyConfigCache</code>：各种缓存类型，用于存储警报规则、用户、用户组、警报订阅、目标和通知配置。</li>
<li><code>alerting</code>：<code>aconf.Alerting</code> 类型，用于警报配置。</li>
<li><code>Senders</code> 和 <code>ExtraSenders</code>：键为字符串，值为 <code>sender.Sender</code> 实例的映射，代表不同的发送机制。<code>Senders</code> 用于存储默认的发送器，而 <code>ExtraSenders</code> 用于存储额外的发送器。</li>
<li><code>tpls</code>：键为字符串，值为模板的映射，用于存储不同通道的消息模板。</li>
<li><code>BeforeSenderHook</code>：函数，它接受一个 <code>models.AlertCurEvent</code> 参数并返回一个布尔值。在发送消息之前被调用，如果返回 <code>true</code>，则继续发送消息；如果返回 <code>false</code>，则停止发送消息。<ul>
<li>AlertCurEvent：当前警报事件的模型结构体</li>
</ul>
</li>
<li><code>ctx</code>：上下文对象。</li>
<li><code>RwLock</code>：读写锁，用于保护 <code>Senders</code> 和 <code>tpls</code> 的并发访问。</li>
</ul>
</li>
</ul>
<p>方法：</p>
<ul>
<li><p><code>NewDispatch</code>：这是 <code>Dispatch</code> 的构造函数，用于创建并初始化 <code>Dispatch</code> 的实例。</p>
</li>
<li><p><code>ReloadTpls</code> 和 <code>relaodTpls</code>：这两个方法用于重新加载模板，并更新 <code>Senders</code> 映射。<code>ReloadTpls</code> 方法会周期性地调用 <code>relaodTpls</code> 方法来重新加载模板。</p>
</li>
<li><p><code>HandleEventNotify</code>：这个方法是处理警报或恢复事件的主逻辑。它首先从缓存中获取警报规则，然后填充事件的用户和用户组信息，然后处理订阅关系和移除订阅关系的逻辑，最后发送消息。</p>
</li>
<li><p><code>handleSubs</code> 和 <code>handleSub</code>：这两个方法用于处理订阅规则的事件。<code>handleSubs</code> 方法获取订阅规则并调用 <code>handleSub</code> 方法来处理每个订阅规则的事件。</p>
</li>
<li><p><code>Send</code>：这个方法用于处理事件的发送。它首先调用 <code>BeforeSenderHook</code> 函数来检查是否需要发送消息，然后通过不同的通道发送消息，并处理事件回调、全局 Webhooks 和插件通知。</p>
<blockquote>
<p>夜莺内置了邮件、企微机器人、钉钉机器人、飞书机器人等通知方式，如果用户在告警规则配置中设置了这些通知方式，夜莺内置就会调用对应的通知方式完成消息推送，如果用户设置了自定义的通知方式，夜莺没有内置对应的通知方法，就会在日志中打印 ’no sender channel: xxx’，这个时候就需要用户在脚本里实现通知方法了。</p>
</blockquote>
<ul>
<li>调用 <code>sender.SendCallbacks</code> 函数来处理事件回调。</li>
<li>调用 <code>sender.SendWebhooks</code> 函数来处理全局 Webhooks。</li>
<li>调用 <code>sender.MayPluginNotify</code> 函数来处理插件通知（通过脚本）。</li>
</ul>
</li>
<li><p><code>genNoticeBytes</code>：这个方法用于生成通知的字节序列。它创建一个 <code>Notice</code> 结构体，然后将其序列化为 JSON 格式的字节序列。</p>
</li>
<li><p><code>fillUsers</code>：这个方法用于填充 <code>models.AlertCurEvent</code> 的 <code>NotifyGroupsObj</code> 和 <code>NotifyUsersObj</code> 字段。它从缓存中获取用户和用户组信息，并设置这些字段。</p>
</li>
</ul>
<p>函数分析：</p>
<ul>
<li><code>mapKeys</code>：从映射中提取键并返回一个切片。</li>
</ul>
<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><p>结构体：</p>
<p><code>Consumer</code> 结构体是告警事件的消费者，它包含以下字段：</p>
<ul>
<li><code>alerting</code>：告警配置。</li>
<li><code>ctx</code>：上下文。</li>
<li><code>dispatch</code>：<code>Dispatch</code> 类型的指针，用于处理告警事件。</li>
</ul>
<p><code>NeNewConsumer</code> 函数：用于创建一个新的<code>Consumer</code>实例。</p>
<ul>
<li><p>参数：</p>
<ul>
<li><p><code>alerting</code>：告警配置。</p>
</li>
<li><p><code>ctx</code>：上下文。</p>
</li>
<li><p><code>dispatch</code>：<code>Dispatch</code> 类型的指针。</p>
</li>
</ul>
</li>
</ul>
<p><code>LoopConsume</code> 方法：是<code>Consumer</code>的主要方法，它循环消费告警事件队列中的事件，并调用<code>consume</code>方法进行处理。</p>
<ul>
<li><p>流程：</p>
<ul>
<li><p>创建一个信号量，用于控制并发消费的数量。</p>
</li>
<li><p>循环从告警事件队列中取出事件。</p>
</li>
<li><p>如果队列为空，则暂停一段时间后继续。</p>
</li>
<li><p>调用<code>consume</code>方法处理取出的事件。</p>
</li>
</ul>
</li>
</ul>
<p><code>consume</code>方法：用于处理一组告警事件。</p>
<ul>
<li><p>参数：</p>
<ul>
<li><p><code>events</code>：告警事件的数组。</p>
</li>
<li><p><code>sema</code>：信号量。</p>
</li>
</ul>
</li>
<li><p>流程：</p>
<ul>
<li><p>遍历告警事件数组。</p>
</li>
<li><p>对每个事件，获取信号量的许可，然后启动一个协程调用<code>consumeOne</code>方法处理该事件。</p>
</li>
</ul>
</li>
</ul>
<p><code>consumeOne</code> 方法：用于处理一个告警事件。</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>event</code>：告警事件。</li>
</ul>
</li>
<li><p>流程：</p>
<ul>
<li><p>记录事件日志。</p>
</li>
<li><p>解析事件的规则名称、规则注释和注解。</p>
</li>
<li><p>调用<code>persist</code>方法持久化事件。</p>
</li>
<li><p>如果事件已恢复并且不需要通知，则返回。</p>
</li>
<li><p>调用<code>dispatch</code>的<code>HandleEventNotify</code>方法处理事件。</p>
</li>
</ul>
</li>
</ul>
<p><code>persist</code> 方法：用于持久化告警事件。</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>event</code>：告警事件。</li>
</ul>
</li>
<li><p>流程：</p>
<ul>
<li><p>如果事件的状态不为0，则返回。</p>
</li>
<li><p>如果当前实例不是中心实例，则将事件发送到中心实例进行持久化。</p>
</li>
<li><p>否则，调用<code>models.EventPersist</code>方法持久化事件。</p>
</li>
</ul>
</li>
</ul>
<h3 id="告警发送渠道"><a href="#告警发送渠道" class="headerlink" title="告警发送渠道"></a>告警发送渠道</h3><p>nightingale-6.1.0&#x2F;alert&#x2F;sender&#x2F;sender.go</p>
<p>结构和类型：</p>
<ul>
<li><code>Sender</code>：一个接口，定义了发送消息通知的方法。任何实现了<code>Send(ctx MessageContext)</code>方法的类型都满足这个接口。</li>
<li><code>MessageContext</code>：一个结构体，代表由事件生成的告警通知的上下文。它包含用户、告警规则和当前告警事件的信息。</li>
</ul>
<p>函数解析：</p>
<ul>
<li><code>NewSender(key string, tpls map[string]*template.Template, smtp ...aconf.SMTPConfig) Sender</code>：根据给定的<code>key</code>创建一个新的<code>Sender</code>。<code>key</code>是一个字符串，它决定了创建哪种类型的<code>Sender</code>。<code>tpls</code>是一个映射，它包含了用于生成消息的模板。<code>smtp</code>是一个可变参数，它包含SMTP配置。</li>
<li><code>BuildMessageContext(rule *models.AlertRule, events []*models.AlertCurEvent, uids []int64, userCache *memsto.UserCacheType) MessageContext</code>：构建并返回一个<code>MessageContext</code>。它使用给定的告警规则、告警事件、用户ID和用户缓存来创建<code>MessageContext</code>。</li>
<li><code>buildTplMessage(tpl *template.Template, events []*models.AlertCurEvent) string</code>：使用给定的模板和告警事件来构建消息。它遍历所有的告警事件，并使用模板来生成每个事件的消息。然后，它将所有的消息连接在一起，并返回结果。</li>
</ul>
<h4 id="邮箱发送"><a href="#邮箱发送" class="headerlink" title="邮箱发送"></a>邮箱发送</h4><p>nightingale-6.1.0&#x2F;alert&#x2F;sender&#x2F;email.go</p>
<h5 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h5><ul>
<li><code>InitEmailSender</code>函数初始化电子邮件发送器，创建一个<code>gomail.Message</code>类型的通道<code>mailch</code>，并调用<code>startEmailSender</code>函数。</li>
<li><code>startEmailSender</code>函数创建一个<code>gomail.Dialer</code>，并在无限循环中从<code>mailch</code>通道中读取消息并发送它们。如果在发送消息时出现错误，它将尝试重新连接到SMTP服务器并重新发送消息。</li>
<li><code>Send</code>方法创建一个<code>gomail.Message</code>并将其发送到<code>mailch</code>通道。<ul>
<li><code>mailch</code> 是一个 Go 语言中的通道（channel），用于在 Go 协程之间传递 <code>*gomail.Message</code> 类型的消息。通道是 Go 语言中一种非常重要的并发编程构造，它允许在不同的 Go 协程之间安全地传递数据。</li>
</ul>
</li>
</ul>
<h4 id="回调发送"><a href="#回调发送" class="headerlink" title="回调发送"></a>回调发送</h4><p>nightingale-6.1.0&#x2F;alert&#x2F;sender&#x2F;callback.go</p>
<p>结构体：</p>
<ul>
<li><code>TaskForm</code>：用于创建Ibex任务的表单。</li>
<li><code>TaskCreateReply</code>：Ibex任务创建的响应。</li>
</ul>
<p>函数解析：</p>
<ul>
<li><code>SendCallbacks(ctx *ctx.Context, urls []string, event *models.AlertCurEvent, targetCache *memsto.TargetCacheType, userCache *memsto.UserCacheType, ibexConf aconf.Ibex)</code>：<ul>
<li>遍历每个URL，发送回调通知。</li>
<li>如果URL以”${ibex}”开头并且事件没有恢复，则处理Ibex任务。</li>
<li>否则，发送JSON格式的事件到指定的URL，并记录响应和状态码。</li>
</ul>
</li>
<li><code>handleIbex(ctx *ctx.Context, url string, event *models.AlertCurEvent, targetCache *memsto.TargetCacheType, userCache *memsto.UserCacheType, ibexConf aconf.Ibex)</code>：<ul>
<li>从URL中解析任务模板ID和主机。</li>
<li>获取任务模板并检查权限。</li>
<li>构建并发送Ibex任务，并记录任务ID和其他相关信息。</li>
</ul>
</li>
<li><code>canDoIbex(ctx *ctx.Context, username string, tpl *models.TaskTpl, host string, targetCache *memsto.TargetCacheType, userCache *memsto.UserCacheType) (bool, error)</code>：<ul>
<li>检查用户是否有权限执行Ibex任务。</li>
<li>如果用户是管理员，返回true。</li>
<li>否则，检查目标的组ID是否与任务模板的组ID匹配。</li>
</ul>
</li>
</ul>
<h4 id="脚本发送"><a href="#脚本发送" class="headerlink" title="脚本发送"></a>脚本发送</h4><p>nightingale-6.1.0&#x2F;alert&#x2F;sender&#x2F;plugin.go</p>
<ul>
<li><code>MayPluginNotify(noticeBytes []byte, notifyScript models.NotifyScript)</code>：<ul>
<li>参数：<ul>
<li><code>noticeBytes</code>：要发送的通知内容的字节切片。</li>
<li><code>notifyScript</code>：包含通知脚本配置的结构体。</li>
</ul>
</li>
<li>逻辑：<ul>
<li>如果<code>noticeBytes</code>为空，则函数直接返回，不执行任何操作。</li>
<li>否则，调用<code>alertingCallScript</code>函数，并传入<code>noticeBytes</code>和<code>notifyScript</code>作为参数。</li>
</ul>
</li>
</ul>
</li>
<li><code>alertingCallScript(stdinBytes []byte, notifyScript models.NotifyScript)</code>：<ul>
<li>参数：<ul>
<li><code>stdinBytes</code>：作为标准输入传递给脚本的字节切片。</li>
<li><code>notifyScript</code>：包含通知脚本配置的结构体。</li>
</ul>
</li>
<li>逻辑：<ul>
<li>检查<code>notifyScript</code>的<code>Enable</code>字段和<code>Content</code>字段。如果<code>Enable</code>为<code>false</code>或<code>Content</code>为空，则函数直接返回。</li>
<li>根据<code>notifyScript</code>的<code>Type</code>字段，确定脚本的文件路径（<code>fpath</code>）。如果<code>Type</code>为1，则<code>fpath</code>就是<code>Content</code>的值；否则，<code>fpath</code>被设置为”.notify_scriptt”。</li>
<li>如果<code>fpath</code>对应的文件不存在或其内容与<code>Content</code>不匹配，则将<code>Content</code>写入<code>fpath</code>对应的文件，并设置文件的权限为0777。</li>
<li>使用<code>exec.Command</code>创建一个命令，该命令执行<code>fpath</code>对应的脚本，并将<code>stdinBytes</code>作为标准输入传递给脚本。</li>
<li>启动命令，并设置命令的超时时间为<code>notifyScript</code>的<code>Timeout</code>字段的值。如果命令超时，则尝试杀死命令，并记录错误日志。</li>
<li>如果命令执行成功，则记录命令的输出；如果命令执行失败，则记录错误日志和命令的输出。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="告警服务整体流程"><a href="#告警服务整体流程" class="headerlink" title="告警服务整体流程"></a>告警服务整体流程</h3><h4 id="1-初始化阶段（Initialize-函数）："><a href="#1-初始化阶段（Initialize-函数）：" class="headerlink" title="1. 初始化阶段（Initialize 函数）："></a>1. 初始化阶段（<code>Initialize</code> 函数）：</h4><ul>
<li><strong>配置初始化：</strong> 通过<code>conf.InitConfig</code>函数读取配置文件和密钥，初始化配置。</li>
<li><strong>日志系统初始化：</strong> 使用<code>logx.Init</code>函数初始化日志系统。</li>
<li><strong>上下文创建：</strong> 使用<code>ctx.NewContext</code>创建新的上下文。</li>
<li>缓存初始化：<ul>
<li>各种状态和告警统计的初始化。</li>
<li>初始化目标缓存、业务组缓存、告警静音缓存、告警规则缓存、通知配置缓存、数据源缓存、用户缓存和用户组缓存。</li>
</ul>
</li>
<li><strong>Prometheus客户端创建：</strong> 用于查询Prometheus的数据。</li>
<li><strong>外部处理器创建：</strong> 用于处理外部告警。</li>
<li><strong>告警服务启动：</strong> 调用<code>Start</code>函数启动告警服务。</li>
<li><strong>HTTP服务启动：</strong> 使用Gin框架启动HTTP服务。</li>
</ul>
<h4 id="2-告警服务启动阶段（Start-函数）："><a href="#2-告警服务启动阶段（Start-函数）：" class="headerlink" title="2. 告警服务启动阶段（Start 函数）："></a>2. 告警服务启动阶段（<code>Start</code> 函数）：</h4><ul>
<li><strong>告警订阅缓存初始化：</strong> 用于缓存告警订阅信息。</li>
<li><strong>记录规则缓存初始化：</strong> 用于缓存记录规则。</li>
<li><strong>告警配置初始化：</strong> 确保数据库中有告警内置告警渠道、渠道机器人和告警模板。</li>
<li><strong>服务列表更新：</strong> 根据心跳配置更新告警引擎中的服务列表。</li>
<li><strong>时序数据库写入初始化：</strong> 初始化写入监控数据的时序数据库。</li>
<li><strong>记录规则调度器创建：</strong> 用于调度记录规则。</li>
<li><strong>告警规则调度器创建：</strong> 用于调度告警规则。</li>
<li><strong>告警发送实例创建：</strong> 创建用于发送告警的实例。</li>
<li><strong>告警消费实例创建：</strong> 创建用于消费告警的实例。</li>
<li><strong>告警模板重载：</strong> 重载告警模板。</li>
<li><strong>告警消费循环：</strong> 启动告警消费循环。</li>
<li><strong>队列大小报告：</strong> 定期报告队列大小。</li>
<li><strong>邮件发送器初始化：</strong> 初始化用于发送邮件的发送器。</li>
</ul>
<h4 id="3-告警处理流程："><a href="#3-告警处理流程：" class="headerlink" title="3. 告警处理流程："></a>3. 告警处理流程：</h4><ul>
<li><strong>创建<code>Dispatch</code>实例：</strong> 用于处理告警分发。</li>
<li><strong>模板重载：</strong> 重载告警模板。</li>
<li><strong>告警消费：</strong> 消费告警队列中的告警。</li>
<li><strong>告警处理：</strong> 根据告警规则和订阅信息处理告警。</li>
<li><strong>告警发送：</strong> 将处理后的告警发送到指定的通道。</li>
</ul>
<h4 id="4-告警发送流程："><a href="#4-告警发送流程：" class="headerlink" title="4. 告警发送流程："></a>4. 告警发送流程：</h4><ul>
<li><strong>构建消息上下文：</strong> 根据告警规则和事件构建消息上下文。</li>
<li><strong>发送消息：</strong> 通过指定的发送器发送消息。</li>
<li><strong>发送回调：</strong> 发送告警回调。</li>
<li><strong>发送Webhooks：</strong> 发送告警Webhooks。</li>
<li><strong>插件通知：</strong> 通过插件发送告警通知。</li>
</ul>
<h1 id="user服务"><a href="#user服务" class="headerlink" title="user服务"></a>user服务</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="comment">// 导入所需的包</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义常量，表示消息通知渠道的类型</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Dingtalk     = <span class="string">&quot;dingtalk&quot;</span>       <span class="comment">// 钉钉</span></span><br><span class="line">	Wecom        = <span class="string">&quot;wecom&quot;</span>          <span class="comment">// 企业微信</span></span><br><span class="line">	Feishu       = <span class="string">&quot;feishu&quot;</span>         <span class="comment">// 飞书</span></span><br><span class="line">	FeishuCard   = <span class="string">&quot;feishucard&quot;</span>     <span class="comment">// 飞书卡片消息</span></span><br><span class="line">	Mm           = <span class="string">&quot;mm&quot;</span>             <span class="comment">// 钉钉移动应用</span></span><br><span class="line">	Telegram     = <span class="string">&quot;telegram&quot;</span>       <span class="comment">// 电报</span></span><br><span class="line">	Email        = <span class="string">&quot;email&quot;</span>          <span class="comment">// 邮件</span></span><br><span class="line">	EmailSubject = <span class="string">&quot;mailsubject&quot;</span>    <span class="comment">// 邮件主题</span></span><br><span class="line"></span><br><span class="line">	DingtalkKey = <span class="string">&quot;dingtalk_robot_token&quot;</span>     <span class="comment">// 钉钉机器人令牌配置键</span></span><br><span class="line">	WecomKey    = <span class="string">&quot;wecom_robot_token&quot;</span>        <span class="comment">// 企业微信机器人令牌配置键</span></span><br><span class="line">	FeishuKey   = <span class="string">&quot;feishu_robot_token&quot;</span>       <span class="comment">// 飞书机器人令牌配置键</span></span><br><span class="line">	MmKey       = <span class="string">&quot;mm_webhook_url&quot;</span>           <span class="comment">// 钉钉移动应用 Webhook URL 配置键</span></span><br><span class="line">	TelegramKey = <span class="string">&quot;telegram_robot_token&quot;</span>     <span class="comment">// 电报机器人令牌配置键</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认消息通知渠道列表</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	DefaultChannels = []<span class="type">string</span>&#123;Dingtalk, Wecom, Feishu, Mm, Telegram, Email, FeishuCard&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户模型</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id         <span class="type">int64</span>        <span class="string">`json:&quot;id&quot; gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">	Username   <span class="type">string</span>       <span class="string">`json:&quot;username&quot;`</span>       <span class="comment">// 用户名</span></span><br><span class="line">	Nickname   <span class="type">string</span>       <span class="string">`json:&quot;nickname&quot;`</span>       <span class="comment">// 昵称</span></span><br><span class="line">	Password   <span class="type">string</span>       <span class="string">`json:&quot;-&quot;`</span>             <span class="comment">// 密码（在 JSON 中不显示）</span></span><br><span class="line">	Phone      <span class="type">string</span>       <span class="string">`json:&quot;phone&quot;`</span>          <span class="comment">// 电话号码</span></span><br><span class="line">	Email      <span class="type">string</span>       <span class="string">`json:&quot;email&quot;`</span>          <span class="comment">// 电子邮件</span></span><br><span class="line">	Portrait   <span class="type">string</span>       <span class="string">`json:&quot;portrait&quot;`</span>       <span class="comment">// 头像</span></span><br><span class="line">	Roles      <span class="type">string</span>       <span class="string">`json:&quot;-&quot;`</span>              <span class="comment">// 用户角色（不在 JSON 中显示）</span></span><br><span class="line">	RolesLst   []<span class="type">string</span>     <span class="string">`json:&quot;roles&quot; gorm:&quot;-&quot;`</span> <span class="comment">// 用户角色列表（在 JSON 中显示）</span></span><br><span class="line">	Contacts   ormx.JSONObj <span class="string">`json:&quot;contacts&quot;`</span>       <span class="comment">// 联系人信息，结构为 map[string]string</span></span><br><span class="line">	Maintainer <span class="type">int</span>          <span class="string">`json:&quot;maintainer&quot;`</span>     <span class="comment">// 是否是管理员，0 表示不是管理员，1 表示是管理员</span></span><br><span class="line">	CreateAt   <span class="type">int64</span>        <span class="string">`json:&quot;create_at&quot;`</span>      <span class="comment">// 创建时间</span></span><br><span class="line">	CreateBy   <span class="type">string</span>       <span class="string">`json:&quot;create_by&quot;`</span>      <span class="comment">// 创建者</span></span><br><span class="line">	UpdateAt   <span class="type">int64</span>        <span class="string">`json:&quot;update_at&quot;`</span>      <span class="comment">// 更新时间</span></span><br><span class="line">	UpdateBy   <span class="type">string</span>       <span class="string">`json:&quot;update_by&quot;`</span>      <span class="comment">// 更新者</span></span><br><span class="line">	Admin      <span class="type">bool</span>         <span class="string">`json:&quot;admin&quot; gorm:&quot;-&quot;`</span> <span class="comment">// 是否是管理员（在 JSON 中显示）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义表名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> TableName() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;users&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将数据库数据转化为前端可用数据的函数，暂未实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> DB2FE() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户的字符串表示形式，主要输出用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">	bs, err := u.Contacts.MarshalJSON()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err.Error()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;&lt;id:%d username:%s nickname:%s email:%s phone:%s contacts:%s&gt;&quot;</span>, u.Id, u.Username, u.Nickname, u.Email, u.Phone, <span class="type">string</span>(bs))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查用户是否是管理员</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> IsAdmin() <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(u.RolesLst); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> u.RolesLst[i] == AdminRole &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证用户信息的有效性</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> Verify() <span class="type">error</span> &#123;</span><br><span class="line">	u.Username = strings.TrimSpace(u.Username)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Username == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;用户名为空&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> str.Dangerous(u.Username) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;用户名包含无效字符&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> str.Dangerous(u.Nickname) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;昵称包含无效字符&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Phone != <span class="string">&quot;&quot;</span> &amp;&amp; !str.IsPhone(u.Phone) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;电话号码无效&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Email != <span class="string">&quot;&quot;</span> &amp;&amp; !str.IsMail(u.Email) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;电子邮件无效&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他函数解析：</p>
<ol>
<li><p><code>func (u *User) Add(ctx *ctx.Context) error</code>: 这个方法用于向数据库中添加新用户。它首先检查数据库中是否已存在具有相同用户名的用户，如果存在则返回错误。然后，它设置用户的创建时间和更新时间为当前时间，并调用 <code>Insert</code> 函数将用户信息插入数据库。</p>
</li>
<li><p><code>func (u *User) Update(ctx *ctx.Context, selectField interface&#123;&#125;, selectFields ...interface&#123;&#125;) error</code>: 这个方法用于更新用户信息。它首先验证用户信息的有效性，然后使用给定的选择字段更新数据库中的用户信息。</p>
</li>
<li><p><code>func (u *User) UpdateAllFields(ctx *ctx.Context) error</code>: 这个方法用于更新用户的所有字段，而不是仅更新指定字段。它首先验证用户信息的有效性，然后将用户的更新时间设置为当前时间，并更新数据库中的用户信息。</p>
</li>
<li><p><code>func (u *User) UpdatePassword(ctx *ctx.Context, password, updateBy string) error</code>: 这个方法用于更新用户的密码。它接受一个新密码和更新者的信息，然后更新用户的密码、更新时间和更新者，并将这些更改保存到数据库中。</p>
</li>
<li><p><code>func (u *User) Del(ctx *ctx.Context) error</code>: 这个方法用于删除用户。它使用事务来执行两个删除操作：首先删除与用户相关的用户组成员信息，然后删除用户自身的信息。</p>
</li>
<li><p><code>func (u *User) ChangePassword(ctx *ctx.Context, oldpass, newpass string) error</code>: 这个方法用于更改用户的密码。它接受旧密码和新密码作为参数，并使用 <code>CryptoPass</code> 函数将它们加密。然后，它检查旧密码是否与数据库中存储的密码匹配，如果匹配则更新密码为新密码。</p>
</li>
<li><p><code>func UserGet(ctx *ctx.Context, where string, args ...interface&#123;&#125;) (*User, error)</code>: 这个函数用于根据给定的条件从数据库中获取用户信息。它接受一个查询条件 <code>where</code> 和可选的查询参数 <code>args</code>，并返回满足条件的第一个用户对象。</p>
</li>
<li><p><code>func UserGetByUsername(ctx *ctx.Context, username string) (*User, error)</code>: 这个函数用于根据用户名从数据库中获取用户信息。</p>
</li>
<li><p><code>func UserGetById(ctx *ctx.Context, id int64) (*User, error)</code>: 这个函数用于根据用户ID从数据库中获取用户信息。</p>
</li>
<li><p><code>func InitRoot(ctx *ctx.Context)</code>: 这个函数用于初始化根用户。它首先尝试获取名为 “root” 的用户，如果该用户不存在，则不执行任何操作。如果用户存在但密码长度小于等于 31，则将用户的密码重新加密并更新到数据库中。</p>
</li>
<li><p><code>func PassLogin(ctx *ctx.Context, username, pass string) (*User, error)</code>: 这个函数用于通过用户名和密码进行登录验证。它首先根据用户名从数据库中获取用户信息，然后将提供的密码与数据库中存储的密码进行比较，如果匹配则返回用户对象，否则返回错误。</p>
</li>
<li><p><code>func LdapLogin(ctx *ctx.Context, username, pass, roles string, ldap *ldapx.SsoClient) (*User, error)</code>: 这个函数用于通过 LDAP 进行登录验证。它接受用户名、密码、角色信息和 LDAP 客户端作为参数。首先，它使用 LDAP 客户端来验证用户名和密码，然后尝试从数据库中获取与用户名匹配的用户信息。如果用户不存在，则创建一个新用户，并从 LDAP 中获取用户的属性（昵称、电子邮件、电话号码等），然后将用户信息保存到数据库中。</p>
</li>
<li><p><code>func UserTotal(ctx *ctx.Context, query string) (num int64, err error)</code>: 这个函数用于获取满足指定查询条件的用户总数。可以通过传递一个查询字符串 <code>query</code> 来筛选用户。如果 <code>query</code> 不为空，则根据用户名、昵称、电话号码或电子邮件进行模糊匹配筛选用户；如果 <code>query</code> 为空，则获取所有用户的总数。</p>
</li>
<li><p><code>func UserGets(ctx *ctx.Context, query string, limit, offset int) ([]User, error)</code>: 这个函数用于根据查询条件获取一定数量的用户列表。它接受查询条件 <code>query</code>、每页返回的用户数量 <code>limit</code> 和偏移量 <code>offset</code> 作为参数，并返回用户列表。同样，如果 <code>query</code> 不为空，则根据用户名、昵称、电话号码或电子邮件进行模糊匹配筛选用户。</p>
</li>
<li><p><code>func UserGetAll(ctx *ctx.Context) ([]*User, error)</code>: 这个函数用于获取所有用户的列表。如果当前上下文不是中心，则使用 <code>poster.GetByUrls</code> 函数从外部服务获取用户列表；否则，从数据库中获取用户列表，并设置用户的角色信息和管理员标志。</p>
</li>
<li><p><code>func UserGetsByIds(ctx *ctx.Context, ids []int64) ([]User, error)</code>: 这个函数用于根据一组用户ID获取用户列表。它接受一个整数切片 <code>ids</code>，包含要获取的用户的ID。然后，它从数据库中获取这些用户，并设置用户的角色信息和管理员标志。</p>
</li>
<li><p><code>func (u *User) CanModifyUserGroup(ctx *ctx.Context, ug *UserGroup) (bool, error)</code>: 这个方法用于检查用户是否有权限修改指定的用户组。它首先检查用户是否是管理员，如果是管理员则具有权限。然后，它检查用户是否是用户组的创建者，如果是创建者也具有权限。最后，它检查用户是否是用户组的成员，如果是成员也具有权限。</p>
</li>
<li><p><code>func (u *User) CanDoBusiGroup(ctx *ctx.Context, bg *BusiGroup, permFlag ...string) (bool, error)</code>: 这个方法用于检查用户是否有权限执行指定的业务组操作。它首先检查用户是否是管理员，如果是管理员则具有权限。然后，它检查用户是否属于任何一个具有指定权限标志的用户组，如果属于任何一个用户组则具有权限。</p>
</li>
<li><p><code>func (u *User) CheckPerm(ctx *ctx.Context, operation string) (bool, error)</code>: 这个方法用于检查用户是否具有执行指定操作的权限。它首先检查用户是否是管理员，如果是管理员则具有权限。否则，它调用 <code>RoleHasOperation</code> 函数检查用户的角色是否具有执行该操作的权限。</p>
</li>
<li><p><code>func UserStatistics(ctx *ctx.Context) (*Statistics, error)</code>: 这个函数用于获取与用户相关的统计信息。如果当前上下文不是中心，则使用 <code>poster.GetByUrls</code> 函数从外部服务获取统计信息；否则，从数据库中获取统计信息，包括用户总数和最后更新时间。</p>
</li>
<li><p><code>func (u *User) NopriIdents(ctx *ctx.Context, idents []string) ([]string, error)</code>: 这个方法用于根据用户的权限过滤一组标识符。如果用户是管理员，则返回原始标识符列表；否则，根据用户的用户组和业务组权限过滤标识符列表。</p>
</li>
</ol>
<h2 id="脚本运行"><a href="#脚本运行" class="headerlink" title="脚本运行"></a>脚本运行</h2><p>说明：在运行脚本的时候，相关程序直接获取前端展示的数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alertingCallScript</span><span class="params">(stdinBytes []<span class="type">byte</span>, notifyScript models.NotifyScript, stats *astats.Stats)</span></span> &#123;</span><br><span class="line">   <span class="comment">// not enable or no notify.py? do nothing</span></span><br><span class="line">   config := notifyScript</span><br><span class="line">   <span class="keyword">if</span> !config.Enable || config.Content == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   channel := <span class="string">&quot;script&quot;</span></span><br><span class="line">   stats.AlertNotifyTotal.WithLabelValues(channel).Inc()</span><br><span class="line">   fpath := <span class="string">&quot;.notify_scriptt&quot;</span></span><br><span class="line">   <span class="keyword">if</span> config.Type == <span class="number">1</span> &#123;</span><br><span class="line">      fpath = config.Content</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      rewrite := <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> file.IsExist(fpath) &#123;</span><br><span class="line">         oldContent, err := file.ToString(fpath)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Errorf(<span class="string">&quot;event_script_notify_fail: read script file err: %v&quot;</span>, err)</span><br><span class="line">            stats.AlertNotifyErrorTotal.WithLabelValues(channel).Inc()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> oldContent == config.Content &#123;</span><br><span class="line">            rewrite = <span class="literal">false</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> rewrite &#123;</span><br><span class="line">         _, err := file.WriteString(fpath, config.Content)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Errorf(<span class="string">&quot;event_script_notify_fail: write script file err: %v&quot;</span>, err)</span><br><span class="line">            stats.AlertNotifyErrorTotal.WithLabelValues(channel).Inc()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         err = os.Chmod(fpath, <span class="number">0777</span>)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Errorf(<span class="string">&quot;event_script_notify_fail: chmod script file err: %v&quot;</span>, err)</span><br><span class="line">            stats.AlertNotifyErrorTotal.WithLabelValues(channel).Inc()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      fpath = <span class="string">&quot;./&quot;</span> + fpath</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   cmd := exec.Command(fpath)</span><br><span class="line">   cmd.Stdin = bytes.NewReader(stdinBytes)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// combine stdout and stderr</span></span><br><span class="line">   <span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">   cmd.Stdout = &amp;buf</span><br><span class="line">   cmd.Stderr = &amp;buf</span><br><span class="line"></span><br><span class="line">   err := startCmd(cmd)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      logger.Errorf(<span class="string">&quot;event_script_notify_fail: run cmd err: %v&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   err, isTimeout := sys.WrapTimeout(cmd, time.Duration(config.Timeout)*time.Second)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> isTimeout &#123;</span><br><span class="line">      <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">         logger.Errorf(<span class="string">&quot;event_script_notify_fail: timeout and killed process %s&quot;</span>, fpath)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         logger.Errorf(<span class="string">&quot;event_script_notify_fail: kill process %s occur error %v&quot;</span>, fpath, err)</span><br><span class="line">         stats.AlertNotifyErrorTotal.WithLabelValues(channel).Inc()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      logger.Errorf(<span class="string">&quot;event_script_notify_fail: exec script %s occur error: %v, output: %s&quot;</span>, fpath, err, buf.String())</span><br><span class="line">      stats.AlertNotifyErrorTotal.WithLabelValues(channel).Inc()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   logger.Infof(<span class="string">&quot;event_script_notify_ok: exec %s output: %s&quot;</span>, fpath, buf.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>检查通知脚本是否启用：</strong><ul>
<li>首先，它检查 <code>notifyScript</code> 中的 <code>Enable</code> 字段是否为 <code>true</code>，以及 <code>Content</code> 字段是否非空。</li>
<li>如果通知脚本未启用或未提供有效的脚本内容，则函数会立即返回，不执行任何后续操作。</li>
</ul>
</li>
<li><strong>增加统计信息：</strong><ul>
<li>如果通知脚本被启用，函数会使用 <code>stats</code> 统计信息对象记录一次通知事件，以标识这次通知是通过 “script” 渠道发送的。</li>
</ul>
</li>
<li><strong>确定脚本文件路径：</strong><ul>
<li>函数根据通知脚本的类型（<code>config.Type</code>）来决定脚本文件的路径。</li>
<li>如果类型是 <code>1</code>，脚本路径将使用 <code>config.Content</code> 字段指定的内容。</li>
<li>否则，函数会检查是否已经存在名为 “.notify_scriptt” 的脚本文件。</li>
<li>如果已存在且内容与配置中的内容相同，函数将不会重写脚本文件，否则将覆盖文件内容。</li>
</ul>
</li>
<li><strong>执行脚本命令：</strong><ul>
<li>使用确定的脚本文件路径创建一个 <code>exec.Command</code> 对象。</li>
<li>将输入数据 <code>stdinBytes</code> 传递给脚本的标准输入。</li>
<li>执行脚本命令，并捕获标准输出和标准错误的内容。</li>
</ul>
</li>
<li><strong>处理命令执行结果：</strong><ul>
<li>如果在启动命令时发生错误，函数将记录错误消息并返回。</li>
<li>如果命令运行超时，函数将记录相应的错误消息，包括超时和进程被终止的信息。</li>
<li>如果命令执行出错，函数将记录错误消息和标准输出&#x2F;标准错误的内容，并增加错误的统计信息。</li>
<li>如果命令成功执行，函数将记录成功的消息以及命令的标准输出内容。</li>
</ul>
</li>
</ol>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/GPIQ4-8o1z7bNJq7M7IvXg">mp.weixin.qq.com&#x2F;s&#x2F;GPIQ4-8o1z7bNJq7M7IvXg</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ayVaQJ8mEacnyMkyqE_rJg">手把手教你使用钉钉发送告警 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36270681/article/details/127517997">夜莺接入飞书告警保姆教程_xiangzilong的博客-CSDN博客</a></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>rhb
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://rshawshank.github.io/2023/09/20/Nightingale%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Nightingale（一）——源码分析">http://rshawshank.github.io/2023/09/20/Nightingale（一）——源码分析/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Nightingale/" rel="tag"><i class="fa fa-tag"></i> Nightingale</a>
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/08/30/sentinel%E9%9B%86%E6%88%90nacos/" rel="prev" title="sentinel集成nacos">
      <i class="fa fa-chevron-left"></i> sentinel集成nacos
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/11/22/netty%EF%BC%88%E4%B8%89%EF%BC%89/" rel="next" title="netty（三）">
      netty（三） <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nightingale%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">Nightingale源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nightingale%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">Nightingale介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9C%E8%8E%BA%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.1.</span> <span class="nav-text">夜莺部署架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#categraf%E9%87%87%E9%9B%86%E7%BB%84%E4%BB%B6"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">categraf采集组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E5%BF%83%E6%B1%87%E8%81%9A%E5%BC%8F%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">中心汇聚式部署方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%B9%E7%BC%98%E4%B8%8B%E6%B2%89%E5%BC%8F%E6%B7%B7%E6%9D%82%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">边缘下沉式混杂部署方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95"><span class="nav-number">1.2.</span> <span class="nav-text">项目目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alert%E5%91%8A%E8%AD%A6%E5%BC%95%E6%93%8E"><span class="nav-number">1.3.</span> <span class="nav-text">alert告警引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%8A%E8%AD%A6%E5%BC%95%E6%93%8E%E7%9B%AE%E5%BD%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">告警引擎目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%8A%E8%AD%A6%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E5%85%A5%E5%8F%A3-Start"><span class="nav-number">1.3.2.</span> <span class="nav-text">告警引擎启动入口-Start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E5%91%8A%E8%AD%A6"><span class="nav-number">1.3.3.</span> <span class="nav-text">发送告警</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E7%9F%A5%E7%9B%AE%E6%A0%87"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">通知目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">生产者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">消费者</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%8A%E8%AD%A6%E5%8F%91%E9%80%81%E6%B8%A0%E9%81%93"><span class="nav-number">1.3.4.</span> <span class="nav-text">告警发送渠道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%82%AE%E7%AE%B1%E5%8F%91%E9%80%81"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">邮箱发送</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.3.4.1.1.</span> <span class="nav-text">工作流程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E5%8F%91%E9%80%81"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">回调发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%8F%91%E9%80%81"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">脚本发送</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%8A%E8%AD%A6%E6%9C%8D%E5%8A%A1%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-number">1.3.5.</span> <span class="nav-text">告警服务整体流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5%EF%BC%88Initialize-%E5%87%BD%E6%95%B0%EF%BC%89%EF%BC%9A"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">1. 初始化阶段（Initialize 函数）：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%91%8A%E8%AD%A6%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%EF%BC%88Start-%E5%87%BD%E6%95%B0%EF%BC%89%EF%BC%9A"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">2. 告警服务启动阶段（Start 函数）：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%91%8A%E8%AD%A6%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">3. 告警处理流程：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%91%8A%E8%AD%A6%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="nav-number">1.3.5.4.</span> <span class="nav-text">4. 告警发送流程：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#user%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">user服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C"><span class="nav-number">2.1.</span> <span class="nav-text">脚本运行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">3.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rhb</p>
  <div class="site-description" itemprop="description">纵浪大化中，不喜亦不惧</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/RShawshank" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;RShawshank" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rhb</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
